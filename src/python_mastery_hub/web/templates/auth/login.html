<!-- Location: src/python_mastery_hub/web/templates/auth/login.html -->

{% extends "base.html" %} {% block title %}Login - Python Mastery Hub{% endblock
%} {% block meta_description %}Sign in to your Python Mastery Hub account to
continue your programming journey{% endblock %} {% block extra_css %}
<style>
  .auth-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 0;
  }

  .auth-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    max-width: 900px;
    width: 100%;
  }

  .auth-left {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 3rem;
    text-align: center;
  }

  .auth-right {
    padding: 3rem;
  }

  .form-floating input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 8px;
    font-weight: 600;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
  }

  .social-btn {
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 0.75rem;
    transition: all 0.3s ease;
    text-decoration: none;
    color: #374151;
  }

  .social-btn:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
    transform: translateY(-2px);
  }

  .divider {
    text-align: center;
    margin: 2rem 0;
    position: relative;
  }

  .divider::before {
    content: "";
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: #e5e7eb;
  }

  .divider span {
    background: white;
    padding: 0 1rem;
    color: #6b7280;
    font-size: 0.9rem;
  }

  .password-toggle {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    border: none;
    background: none;
    color: #6b7280;
    cursor: pointer;
    z-index: 5;
  }

  .form-floating {
    position: relative;
  }

  .alert {
    border-radius: 8px;
    border: none;
  }

  @media (max-width: 768px) {
    .auth-left {
      padding: 2rem 1rem;
    }

    .auth-right {
      padding: 2rem 1rem;
    }

    .auth-container {
      padding: 1rem;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="auth-container">
  <div class="auth-card">
    <div class="row g-0">
      <!-- Left Side - Branding -->
      <div class="col-md-5 auth-left d-flex flex-column justify-content-center">
        <div>
          <img
            src="{{ url_for('static', path='images/logo-white.svg') }}"
            alt="Python Mastery Hub"
            height="40"
            class="mb-4"
          />
          <h2 class="h3 fw-bold mb-3">Welcome Back!</h2>
          <p class="mb-4 opacity-90">
            Continue your Python learning journey. Master programming through
            interactive exercises and hands-on practice.
          </p>

          <!-- Quick Stats -->
          <div class="row text-center mt-4">
            <div class="col-4">
              <div class="fw-bold h5">50K+</div>
              <div class="small opacity-75">Students</div>
            </div>
            <div class="col-4">
              <div class="fw-bold h5">500+</div>
              <div class="small opacity-75">Exercises</div>
            </div>
            <div class="col-4">
              <div class="fw-bold h5">95%</div>
              <div class="small opacity-75">Success Rate</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Side - Login Form -->
      <div class="col-md-7 auth-right">
        <div class="text-center mb-4">
          <h1 class="h4 fw-bold text-dark">Sign In</h1>
          <p class="text-muted">
            Enter your credentials to access your account
          </p>
        </div>

        <!-- Login Form -->
        <form id="loginForm" novalidate>
          <!-- Alert Container -->
          <div id="alertContainer"></div>

          <!-- Username/Email Field -->
          <div class="form-floating mb-3">
            <input
              type="text"
              class="form-control"
              id="usernameOrEmail"
              placeholder="Enter username or email"
              required
            />
            <label for="usernameOrEmail">Username or Email</label>
            <div class="invalid-feedback"></div>
          </div>

          <!-- Password Field -->
          <div class="form-floating mb-3">
            <input
              type="password"
              class="form-control"
              id="password"
              placeholder="Enter password"
              required
            />
            <label for="password">Password</label>
            <button
              type="button"
              class="password-toggle"
              onclick="togglePassword('password')"
            >
              <i class="fas fa-eye" id="password-eye"></i>
            </button>
            <div class="invalid-feedback"></div>
          </div>

          <!-- Remember Me & Forgot Password -->
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="rememberMe" />
              <label class="form-check-label" for="rememberMe">
                Remember me
              </label>
            </div>
            <a href="/forgot-password" class="text-decoration-none">
              Forgot password?
            </a>
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            class="btn btn-primary w-100 mb-3"
            id="submitBtn"
          >
            <span class="btn-text">Sign In</span>
            <span class="spinner-border spinner-border-sm d-none" role="status">
              <span class="visually-hidden">Loading...</span>
            </span>
          </button>
        </form>

        <!-- Social Login -->
        <div class="divider">
          <span>or continue with</span>
        </div>

        <div class="row g-2 mb-4">
          <div class="col-6">
            <a
              href="/auth/google"
              class="social-btn d-flex align-items-center justify-content-center w-100"
            >
              <i class="fab fa-google me-2"></i>
              Google
            </a>
          </div>
          <div class="col-6">
            <a
              href="/auth/github"
              class="social-btn d-flex align-items-center justify-content-center w-100"
            >
              <i class="fab fa-github me-2"></i>
              GitHub
            </a>
          </div>
        </div>

        <!-- Sign Up Link -->
        <div class="text-center">
          <p class="text-muted mb-0">
            Don't have an account?
            <a href="/register" class="text-decoration-none fw-semibold">
              Sign up for free
            </a>
          </p>
        </div>

        <!-- Demo Account -->
        <div class="text-center mt-3">
          <button
            type="button"
            class="btn btn-outline-secondary btn-sm"
            onclick="fillDemoCredentials()"
          >
            <i class="fas fa-user me-1"></i>
            Try Demo Account
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("loginForm");
    const submitBtn = document.getElementById("submitBtn");
    const alertContainer = document.getElementById("alertContainer");

    // Form submission
    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      if (!validateForm()) {
        return;
      }

      const formData = {
        username_or_email: document.getElementById("usernameOrEmail").value,
        password: document.getElementById("password").value,
        remember_me: document.getElementById("rememberMe").checked,
      };

      try {
        setLoading(true);
        clearAlerts();

        const response = await fetch("/api/auth/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(formData),
        });

        const data = await response.json();

        if (response.ok) {
          // Store tokens
          localStorage.setItem("access_token", data.access_token);
          localStorage.setItem("refresh_token", data.refresh_token);

          showAlert("Login successful! Redirecting...", "success");

          // Redirect after short delay
          setTimeout(() => {
            const redirect =
              new URLSearchParams(window.location.search).get("redirect") ||
              "/dashboard";
            window.location.href = redirect;
          }, 1000);
        } else {
          showAlert(data.detail || "Login failed. Please try again.", "danger");
        }
      } catch (error) {
        console.error("Login error:", error);
        showAlert(
          "Network error. Please check your connection and try again.",
          "danger"
        );
      } finally {
        setLoading(false);
      }
    });

    // Real-time validation
    document
      .getElementById("usernameOrEmail")
      .addEventListener("blur", validateUsername);
    document
      .getElementById("password")
      .addEventListener("blur", validatePassword);

    // Auto-fill from URL parameters (for demo purposes)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get("demo") === "true") {
      fillDemoCredentials();
    }
  });

  function validateForm() {
    const isUsernameValid = validateUsername();
    const isPasswordValid = validatePassword();

    return isUsernameValid && isPasswordValid;
  }

  function validateUsername() {
    const input = document.getElementById("usernameOrEmail");
    const value = input.value.trim();

    if (!value) {
      setFieldError(input, "Username or email is required");
      return false;
    }

    if (value.length < 3) {
      setFieldError(input, "Username must be at least 3 characters");
      return false;
    }

    clearFieldError(input);
    return true;
  }

  function validatePassword() {
    const input = document.getElementById("password");
    const value = input.value;

    if (!value) {
      setFieldError(input, "Password is required");
      return false;
    }

    if (value.length < 6) {
      setFieldError(input, "Password must be at least 6 characters");
      return false;
    }

    clearFieldError(input);
    return true;
  }

  function setFieldError(input, message) {
    input.classList.add("is-invalid");
    input.classList.remove("is-valid");
    const feedback = input.parentNode.querySelector(".invalid-feedback");
    if (feedback) {
      feedback.textContent = message;
    }
  }

  function clearFieldError(input) {
    input.classList.remove("is-invalid");
    input.classList.add("is-valid");
  }

  function setLoading(loading) {
    const submitBtn = document.getElementById("submitBtn");
    const btnText = submitBtn.querySelector(".btn-text");
    const spinner = submitBtn.querySelector(".spinner-border");

    if (loading) {
      submitBtn.disabled = true;
      btnText.textContent = "Signing In...";
      spinner.classList.remove("d-none");
    } else {
      submitBtn.disabled = false;
      btnText.textContent = "Sign In";
      spinner.classList.add("d-none");
    }
  }

  function showAlert(message, type) {
    const alertContainer = document.getElementById("alertContainer");
    const alertHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    alertContainer.innerHTML = alertHTML;
  }

  function clearAlerts() {
    document.getElementById("alertContainer").innerHTML = "";
  }

  function togglePassword(fieldId) {
    const input = document.getElementById(fieldId);
    const eye = document.getElementById(fieldId + "-eye");

    if (input.type === "password") {
      input.type = "text";
      eye.classList.remove("fa-eye");
      eye.classList.add("fa-eye-slash");
    } else {
      input.type = "password";
      eye.classList.remove("fa-eye-slash");
      eye.classList.add("fa-eye");
    }
  }

  function fillDemoCredentials() {
    document.getElementById("usernameOrEmail").value =
      "demo@pythonmasteryhub.com";
    document.getElementById("password").value = "demo123";
    showAlert('Demo credentials filled. Click "Sign In" to continue.', "info");
  }

  // Handle Enter key in form fields
  document.addEventListener("keydown", function (e) {
    if (e.key === "Enter" && document.activeElement.closest("#loginForm")) {
      e.preventDefault();
      document.getElementById("loginForm").dispatchEvent(new Event("submit"));
    }
  });

  // Check if user is already logged in
  document.addEventListener("DOMContentLoaded", function () {
    const token = localStorage.getItem("access_token");
    if (token) {
      // Verify token is still valid
      fetch("/api/auth/me", {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      })
        .then((response) => {
          if (response.ok) {
            // User is already logged in, redirect to dashboard
            window.location.href = "/dashboard";
          }
        })
        .catch((error) => {
          // Token is invalid, remove it
          localStorage.removeItem("access_token");
          localStorage.removeItem("refresh_token");
        });
    }
  });

  // Handle back button
  window.addEventListener("popstate", function (e) {
    // Clear any sensitive form data when navigating back
    document.getElementById("password").value = "";
  });
</script>
{% endblock %}
